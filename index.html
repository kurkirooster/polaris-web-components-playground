<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Approosters - Polaris web components playground</title>

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>

    <style>
      :root {
        --bg-main: #1e1e1e;
        --bg-header: #252526;
        --border-color: #333333;
        --text-primary: #cccccc;
      }

      body {
        margin: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--bg-main);
        color: var(--text-primary);
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
      }

      .header {
        padding: 12px 20px;
        background: var(--bg-header);
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      .controls {
        display: flex;
        gap: 15px;
        font-size: 13px;
      }

      .controls label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        user-select: none;
      }

      /* Main layout */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Top pane (editor + preview) */
      .workspace {
        flex: 2; /* Takes up 2/3 space by default */
        display: flex;
        overflow: hidden;
        min-height: 50px;
      }

      .pane-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-width: 0; /* Prevent flex overflow */
      }

      /* CodeMirror */
      .CodeMirror {
        flex: 1;
        height: 100%;
        font-size: 14px;
        background: var(--bg-main);
        border-right: 1px solid var(--border-color);
      }

      .preview-frame {
        flex: 1;
        border: none;
        background: #f1f1f1;
      }

      .preview-frame[style*="display: none"] {
        position: absolute;
        visibility: hidden;
      }

      /* Resizer handle (vertical: splits top/bottom) */
      .resizer {
        height: 6px;
        background: var(--bg-header);
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        cursor: row-resize;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }

      .resizer:hover {
        background: #3c3c3c;
      }

      .resizer::after {
        content: "";
        width: 30px;
        height: 4px;
        border-radius: 2px;
        background: #555;
      }

      /* Horizontal resizer (splits left/right) */
      .resizer-horizontal {
        width: 6px;
        background: var(--bg-header);
        border-left: 1px solid var(--border-color);
        border-right: 1px solid var(--border-color);
        cursor: col-resize;
        flex-shrink: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .resizer-horizontal:hover {
        background: #3c3c3c;
      }

      .resizer-horizontal::after {
        content: "";
        height: 30px;
        width: 4px;
        border-radius: 2px;
        background: #555;
      }

      /* Bottom pane (documentation) */
      .documentation-pane {
        flex: 1; /* Takes up 1/3 space by default */
        display: flex;
        border: none;
        background: #fff;
        min-height: 50px;
      }

      .documentation-frame {
        flex: 1;
        border: none;
        width: 100%;
        height: 100%;
      }

      /* Utility */
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Approosters - Polaris web components playground</h1>
      <div class="controls">
        <label><input type="checkbox" id="toggleEditor" checked /> Editor</label>
        <label><input type="checkbox" id="togglePreview" checked /> Preview</label>
        <label><input type="checkbox" id="toggleDocs" checked /> Documentation</label>
      </div>
    </div>

    <div class="main-content">
      <!-- Top workspace: editor + preview -->
      <div class="workspace" id="workspace">
        <div id="editorPane" class="pane-content">
          <textarea id="editor"></textarea>
        </div>

        <div class="resizer-horizontal" id="resizerH"></div>

        <div id="previewPane" class="pane-content">
          <iframe id="preview1" class="preview-frame"></iframe>
          <iframe id="preview2" class="preview-frame" style="display: none"></iframe>
        </div>
      </div>

      <!-- Resizer handle -->
      <div class="resizer" id="resizer"></div>

      <!-- Bottom documentation pane -->
      <div class="documentation-pane" id="docPane">
        <iframe
          src="https://shopify.dev/docs/api/app-home/polaris-web-components"
          class="documentation-frame"
          title="Polaris Web Components Documentation"
        ></iframe>
      </div>
    </div>

    <script>
      // Double-buffered iframes for flash-free updates
      const previews = [document.getElementById("preview1"), document.getElementById("preview2")];
      let activeIndex = 0;

      const TEMPLATE_CODE = `<s-page heading="Settings" inlineSize="small">
	<s-section heading="Store Information">
		<s-text-field
			label="Store name"
			name="store-name"
			value="Approosters Store"
			placeholder="Enter store name"
		/>
		<s-text-field
			label="Business address"
			name="business-address"
			value="123 Main St, Anytown, USA"
			placeholder="Enter business address"
		/>
		<s-text-field
			label="Store phone"
			name="store-phone"
			value="+1 (555) 123-4567"
			placeholder="Enter phone number"
		/>
		<s-choice-list label="Primary currency" name="currency">
			<s-choice value="usd" selected>
				US Dollar ($)
			</s-choice>
			<s-choice value="cad">Canadian Dollar (CAD)</s-choice>
			<s-choice value="eur">Euro (â‚¬)</s-choice>
		</s-choice-list>
	</s-section>

	<s-section heading="Notifications">
		<s-select
			label="Notification frequency"
			name="notification-frequency"
		>
			<s-option value="immediately" selected>
				Immediately
			</s-option>
			<s-option value="hourly">Hourly digest</s-option>
			<s-option value="daily">Daily digest</s-option>
		</s-select>
		<s-choice-list
			label="Notification types"
			name="notifications-type"
			multiple
		>
			<s-choice value="new-order" selected>
				New order notifications
			</s-choice>
			<s-choice value="low-stock">Low stock alerts</s-choice>
			<s-choice value="customer-review">
				Customer review notifications
			</s-choice>
			<s-choice value="shipping-updates">Shipping updates</s-choice>
		</s-choice-list>
	</s-section>

	<s-section heading="Preferences">
		<s-box border="base" borderRadius="base">
			<s-clickable
				padding="small-100"
				accessibilityLabel="Configure shipping methods, rates, and fulfillment options"
			>
				<s-grid
					gridTemplateColumns="1fr auto"
					alignItems="center"
					gap="base"
				>
					<s-box>
						<s-heading>Shipping & fulfillment</s-heading>
						<s-paragraph color="subdued">
							Shipping methods, rates, zones, and fulfillment preferences.
						</s-paragraph>
					</s-box>
					<s-icon type="chevron-right" />
				</s-grid>
			</s-clickable>
			<s-box paddingInline="small-100">
				<s-divider />
			</s-box>

			<s-clickable
				padding="small-100"
				accessibilityLabel="Configure product defaults, customer experience, and catalog settings"
			>
				<s-grid
					gridTemplateColumns="1fr auto"
					alignItems="center"
					gap="base"
				>
					<s-box>
						<s-heading>Products & catalog</s-heading>
						<s-paragraph color="subdued">
							Product defaults, customer experience, and catalog display
							options.
						</s-paragraph>
					</s-box>
					<s-icon type="chevron-right" />
				</s-grid>
			</s-clickable>
			<s-box paddingInline="small-100">
				<s-divider />
			</s-box>

			<s-clickable
				padding="small-100"
				accessibilityLabel="Manage customer support settings and help resources"
			>
				<s-grid
					gridTemplateColumns="1fr auto"
					alignItems="center"
					gap="base"
				>
					<s-box>
						<s-heading>Customer support</s-heading>
						<s-paragraph color="subdued">
							Support settings, help resources, and customer service
							tools.
						</s-paragraph>
					</s-box>
					<s-icon type="chevron-right" />
				</s-grid>
			</s-clickable>
		</s-box>
	</s-section>

	<s-section heading="Tools">
		<s-stack
			gap="none"
			border="base"
			borderRadius="base"
			overflow="hidden"
		>
			<s-box padding="small-100">
				<s-grid
					gridTemplateColumns="1fr auto"
					alignItems="center"
					gap="base"
				>
					<s-box>
						<s-heading>Reset app settings</s-heading>
						<s-paragraph color="subdued">
							Reset all settings to their default values. This action
							cannot be undone.
						</s-paragraph>
					</s-box>
					<s-button tone="critical">Reset</s-button>
				</s-grid>
			</s-box>
			<s-box paddingInline="small-100">
				<s-divider />
			</s-box>

			<s-box padding="small-100">
				<s-grid
					gridTemplateColumns="1fr auto"
					alignItems="center"
					gap="base"
				>
					<s-box>
						<s-heading>Export settings</s-heading>
						<s-paragraph color="subdued">
							Download a backup of all your current settings.
						</s-paragraph>
					</s-box>
					<s-button>Export</s-button>
				</s-grid>
			</s-box>
		</s-stack>
	</s-section>
</s-page>`;

      // CodeMirror setup
      const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        mode: "text/html",
        theme: "material-darker",
        lineNumbers: true,
        tabSize: 4,
        indentUnit: 4,
        indentWithTabs: true,
      });
      editor.setValue(TEMPLATE_CODE);

      // Expand self-closing custom elements
      function normalizeCustomElements(html) {
        return html.replace(/<([a-z]+-[a-z0-9-]+)([^>]*)\s*\/>/gi, "<$1$2></$1>");
      }

      const POLARIS_HTML = `
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<script type="module" src="https://cdn.shopify.com/shopifycloud/polaris.js"><\/script>
	<style>
		body {
			padding: 24px;
			margin: 0;
			font-family: system-ui, -apple-system, sans-serif;
			background: #f1f1f1;
		}
	</style>
</head>
<body>
{{CONTENT}}
</body>
</html>
			`;

      function updatePreview() {
        const raw = editor.getValue();
        const normalized = normalizeCustomElements(raw);
        const nextIndex = 1 - activeIndex;
        const nextFrame = previews[nextIndex];
        const currentFrame = previews[activeIndex];

        nextFrame.onload = () => {
          // Swap visibility: show the newly loaded frame, hide the old one
          currentFrame.style.display = "none";
          nextFrame.style.display = "block";
          activeIndex = nextIndex;
        };

        nextFrame.srcdoc = POLARIS_HTML.replace("{{CONTENT}}", normalized);
      }

      editor.on("change", updatePreview);
      updatePreview();

      // Resizer & toggle logic
      const resizerV = document.getElementById("resizer"); // Vertical resizer
      const resizerH = document.getElementById("resizerH"); // Horizontal resizer

      const workspace = document.getElementById("workspace");
      const docPane = document.getElementById("docPane");
      const editorPane = document.getElementById("editorPane");
      const previewPane = document.getElementById("previewPane");
      const mainContent = document.querySelector(".main-content");

      // Toggles
      const toggleEditor = document.getElementById("toggleEditor");
      const togglePreview = document.getElementById("togglePreview");
      const toggleDocs = document.getElementById("toggleDocs");

      // Shared resize state
      let isResizingV = false;
      let isResizingH = false;

      // Vertical resizing (workspace vs docs)
      if (resizerV) {
        resizerV.addEventListener("mousedown", (e) => {
          isResizingV = true;
          document.body.style.cursor = "row-resize";
          document.body.style.userSelect = "none"; // Disable text selection
          disableIframes();
          e.preventDefault(); // Prevent accidental drag initiations
        });
      }

      // Horizontal resizing (editor vs preview)
      if (resizerH) {
        resizerH.addEventListener("mousedown", (e) => {
          isResizingH = true;
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none"; // Disable text selection
          disableIframes();
          e.preventDefault(); // Prevent accidental drag initiations
        });
      }

      // Global mouse move
      document.addEventListener("mousemove", (e) => {
        if (!isResizingV && !isResizingH) return;

        // Prevent text selection
        e.preventDefault();

        if (isResizingV) {
          const headerHeight = document.querySelector(".header").offsetHeight;
          const totalHeight = mainContent.offsetHeight;
          const pointerRelativeY = e.clientY - headerHeight;

          // Constraints
          const minHeight = 50;
          const maxPos = totalHeight - minHeight;
          const constrainedY = Math.max(minHeight, Math.min(pointerRelativeY, maxPos));

          // Disconnect flex grow to use precise pixels
          workspace.style.flex = "none";
          docPane.style.flex = "none";

          workspace.style.height = `${constrainedY}px`;
          docPane.style.height = `${totalHeight - constrainedY - resizerV.offsetHeight}px`;
        }

        if (isResizingH) {
          const workspaceRect = workspace.getBoundingClientRect();
          const pointerRelativeX = e.clientX - workspaceRect.left;

          const minWidth = 400;
          const maxWidth = workspaceRect.width - minWidth;
          const constrainedX = Math.max(minWidth, Math.min(pointerRelativeX, maxWidth));

          editorPane.style.flex = "none";
          previewPane.style.flex = "none";

          editorPane.style.width = `${constrainedX}px`;
          previewPane.style.width = `${workspaceRect.width - constrainedX - resizerH.offsetWidth}px`;

          // Refresh CodeMirror layout ensuring it redraws correctly
          editor.refresh();
        }
      });

      // Global mouse up
      document.addEventListener("mouseup", () => {
        if (isResizingV || isResizingH) {
          isResizingV = false;
          isResizingH = false;
          document.body.style.cursor = "";
          document.body.style.userSelect = ""; // Re-enable text selection
          enableIframes();
        }
      });

      // Visibility toggles
      function updateLayoutVisibility() {
        // Toggle classes
        if (toggleEditor.checked) editorPane.classList.remove("hidden");
        else editorPane.classList.add("hidden");

        if (togglePreview.checked) previewPane.classList.remove("hidden");
        else previewPane.classList.add("hidden");

        if (toggleDocs.checked) {
          docPane.classList.remove("hidden");
          resizerV.classList.remove("hidden");
        } else {
          docPane.classList.add("hidden");
          resizerV.classList.add("hidden");
          // If docs hidden, workspace takes full height
          workspace.style.flex = "1";
          workspace.style.height = "auto";
        }

        // Horizontal resizer visibility
        if (toggleEditor.checked && togglePreview.checked) {
          resizerH.classList.remove("hidden");
        } else {
          resizerH.classList.add("hidden");
          // If one is hidden, the other takes full width
          if (toggleEditor.checked) {
            editorPane.style.flex = "1";
            editorPane.style.width = "auto";
          }
          if (togglePreview.checked) {
            previewPane.style.flex = "1";
            previewPane.style.width = "auto";
          }
        }

        // Refresh editor in case size changed drastically
        setTimeout(() => editor.refresh(), 0);
      }

      toggleEditor.addEventListener("change", updateLayoutVisibility);
      togglePreview.addEventListener("change", updateLayoutVisibility);
      toggleDocs.addEventListener("change", updateLayoutVisibility);

      // Helper: Iframe pointer events
      function disableIframes() {
        document.querySelectorAll("iframe").forEach((iframe) => (iframe.style.pointerEvents = "none"));
      }
      function enableIframes() {
        document.querySelectorAll("iframe").forEach((iframe) => (iframe.style.pointerEvents = ""));
      }
    </script>
  </body>
</html>
